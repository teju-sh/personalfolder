<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Organizer</title>
    <!--
      Tailwind CSS for styling.
      In a production app, this would be installed via NPM and processed.
      Using the Play CDN for simplicity.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--
      Inter font, a clean, modern font for the UI.
    -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!--
      Lucide icons for a consistent icon set.
    -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!--
      PWA Support: Link to the Web Manifest file
    -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Theme Color (for mobile browser chrome) -->
    <meta name="theme-color" content="#4f46e5">

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents "pull-to-refresh" on mobile */
        }

        /* Custom scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Hide the default file input */
        .file-input-hidden {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        /* Custom file input label */
        .file-input-label {
            cursor: pointer;
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: #f1f5f9;
            color: #334155;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #e2e8f0;
        }

        /* Loading spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styling for the main app container on mobile */
        #app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* On larger screens, simulate a mobile phone frame */
        @media (min-width: 640px) {
            body {
                background-color: #e5e7eb; /* Light gray background */
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }
            #app-container {
                max-width: 420px; /* Typical phone width */
                max-height: 850px; /* Typical phone height */
                border-radius: 2rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: 8px solid #111827; /* Phone bezel */
                position: relative;
            }
        }
    </style>
</head>
<body class="bg-white">

    <!-- 
      Main Application Container
      This div contains the entire app UI.
    -->
    <div id="app-container" class="bg-slate-50">

        <!-- 
          App Header
          Contains the title, user ID, and new reminder button.
        -->
        <header class="bg-indigo-600 text-white p-4 shadow-md z-10 rounded-t-2xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">Student Organizer</h1>
                    <p id="user-id-display" class="text-xs text-indigo-200">User ID: N/A</p>
                </div>
                <!-- New Reminder Button -->
                <button id="show-reminder-modal-btn" class="bg-indigo-500 hover:bg-indigo-400 text-white p-2 rounded-full shadow-lg transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                </button>
            </div>
        </header>

        <!-- 
          Offline/Error Warning Banner
          Hidden by default, shown if Firebase fails or is unavailable.
        -->
        <div id="offline-warning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
            <p class="font-bold">Offline Mode</p>
            <p id="offline-message">Firebase is not connected. Data will not be saved.</p>
        </div>

        <!-- 
          App Navigation
          Tabs to switch between Files, Reminders, and Study AI.
        -->
        <nav class="flex justify-around bg-white shadow-sm border-b border-slate-200">
            <button data-tab="files" class="nav-tab flex-1 py-4 px-6 text-center font-medium text-indigo-600 border-b-2 border-indigo-600">
                Files
            </button>
            <button data-tab="reminders" class="nav-tab flex-1 py-4 px-6 text-center font-medium text-slate-500 hover:text-indigo-600">
                Reminders
            </button>
            <button data-tab="study-ai" class="nav-tab flex-1 py-4 px-6 text-center font-medium text-slate-500 hover:text-indigo-600">
                âœ¨ Study AI
            </button>
        </nav>

        <!-- 
          Main Content Area
          This is where the tab content will be dynamically loaded.
        -->
        <main class="flex-1 overflow-y-auto custom-scrollbar p-4 bg-slate-50">

            <!-- 
              Initialization View
              Shown on first load while connecting to Firebase.
            -->
            <div id="initializing-view" class="text-center p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-4 text-slate-600">Initializing views...</p>
            </div>

            <!-- 
              Files Tab Section (Default)
            -->
            <section id="files-section" class="tab-content hidden">
                <!-- 
                  File View: This view shows the list of files *inside* a selected folder.
                  It is hidden by default.
                -->
                <div id="file-list-view" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button id="back-to-folders-btn" class="flex items-center text-indigo-600 hover:underline">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="m15 18-6-6 6-6"/></svg>
                            Back
                        </button>
                        <button id="show-import-modal-from-file-view-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200">
                            Import File
                        </button>
                    </div>
                    <h2 id="current-folder-name" class="text-2xl font-bold text-slate-800 mb-4"></h2>
                    <div id="file-list-container" class="space-y-3">
                        <!-- File items will be dynamically inserted here -->
                        <!-- 
                        Example file item:
                        <div class="file-item bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50" data-url="...">
                            <div class="flex items-center">
                                <svg ...>...</svg> <!-- Icon -->
                                <span class="ml-3 font-medium text-slate-700">file_name.pdf</span>
                            </div>
                            <svg ...>...</svg> <!-- Chevron right -->
                        </div>
                        -->
                    </div>
                    <p id="no-files-message" class="hidden text-center text-slate-500 py-8">No files in this folder.</p>
                </div>

                <!-- 
                  Folder View: This view shows the list of all folders (root view).
                  It is hidden by default, but will be shown first.
                -->
                <div id="folder-list-view">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">My Folders</h2>
                        <div class="flex space-x-2">
                            <button id="show-quick-import-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200">
                                Quick Import
                            </button>
                            <button id="show-folder-modal-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                                New Folder
                            </button>
                        </div>
                    </div>
                    <div id="folder-list-container" class="space-y-3">
                        <!-- Folder items will be dynamically inserted here -->
                        <!-- 
                        Example folder item:
                        <div class="folder-item bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50" data-id="folderId">
                            <div class="flex items-center">
                                <svg ...>...</svg> <!-- Folder Icon -->
                                <span class="ml-3 font-medium text-slate-700">Folder Name</span>
                            </div>
                            <button class="delete-folder-btn text-red-400 hover:text-red-600" data-id="folderId">
                                <svg ...>...</svg> <!-- Delete Icon -->
                            </button>
                        </div>
                        -->
                    </div>
                    <p id="no-folders-message" class="hidden text-center text-slate-500 py-8">No folders found. Create one to get started.</p>
                </div>
            </section>

            <!-- 
              Reminders Tab Section
            -->
            <section id="reminders-section" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">My Reminders</h2>
                <div id="reminders-list-container" class="space-y-4">
                    <!-- Reminder items will be dynamically inserted here -->
                    <!-- 
                    Example reminder item:
                    <div class="bg-white p-4 rounded-lg shadow-sm relative">
                        <button class="delete-reminder-btn ...">...</button>
                        <p class="font-semibold text-slate-800">Reminder Title</p>
                        <p class="text-sm text-slate-500">Due: ...</p>
                        <div class="mt-2 pl-4 border-l-2 border-indigo-200 space-y-1">
                            <p class...>- Sub-task 1</p>
                            <p class...>- Sub-task 2</p>
                        </div>
                    </div>
                    -->
                </div>
                <p id="no-reminders-message" class="hidden text-center text-slate-500 py-8">No reminders set.</p>
            </section>

            <!-- 
              Study AI Tab Section
            -->
            <section id="study-ai-section" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">âœ¨ Study AI Assistant</h2>
                
                <!-- AI Image Upload Section -->
                <div class="mb-4">
                    <input type="file" id="study-ai-image-input" class="file-input-hidden" accept="image/*">
                    <div class="flex items-center space-x-2">
                        <label for="study-ai-image-input" class="file-input-label !py-2 !px-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </label>
                        <span id="study-ai-image-filename" class="text-sm text-slate-500 italic">Upload an image (optional)</span>
                    </div>
                    <img id="study-ai-image-preview" src="" alt="Image preview" class="hidden rounded-lg mt-2 max-h-48 w-auto"/>
                </div>

                <!-- AI Query Input -->
                <div class="flex space-x-2">
                    <input type="text" id="study-ai-input" class="flex-1 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ask about the image or just ask a question...">
                    <button id="study-ai-ask-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-5 rounded-lg shadow-sm transition duration-200">
                        Ask
                    </button>
                </div>
                
                <!-- AI Response Area -->
                <div class="mt-6">
                    <h3 id="study-ai-result-header" class="font-semibold text-lg text-slate-800 hidden">Result:</h3>
                    
                    <!-- AI TTS (Text-to-Speech) Button -->
                    <button id="study-ai-speak-btn" class="hidden my-2 flex items-center space-x-1 text-sm text-indigo-600 font-medium hover:underline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <span id="study-ai-speak-btn-text">Read Aloud</span>
                        <div id="study-ai-speak-btn-spinner" class="spinner !w-4 !h-4 !border-2 hidden"></div>
                    </button>

                    <!-- Loading Indicator -->
                    <div id="study-ai-loading" class="hidden text-center p-4">
                        <div class="spinner mx-auto"></div>
                        <p class="mt-2 text-slate-600">Thinking...</p>
                    </div>

                    <!-- Response Content -->
                    <div id="study-ai-output" class="prose prose-sm mt-2 max-w-none text-slate-700"></div>

                    <!-- Citations/Sources -->
                    <div id="study-ai-sources" class="mt-4 hidden">
                        <h4 class="font-semibold text-sm text-slate-600">Sources:</h4>
                        <ul id="study-ai-sources-list" class="list-disc list-inside text-sm mt-1 space-y-1">
                            <!-- Sources will be injected here -->
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 
      MODALS
      These are hidden overlays for specific actions.
    -->

    <!-- 
      Create New Folder Modal
    -->
    <div id="create-folder-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">Create New Folder</h3>
            <input type="text" id="folder-name-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 'Biology Notes'">
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal('create-folder-modal')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="create-folder-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200">
                    Create
                </button>
            </div>
        </div>
    </div>

    <!-- 
      Import & Convert File Modal
      This is the modal used when clicking "Quick Import" or "Import File".
    -->
    <div id="import-file-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold text-slate-800 mb-6">Import & Convert File</h3>
            
            <!-- Folder Selection (Contextual) -->
            <div id="import-folder-select-container" class="mb-4">
                <label for="import-folder-select" class="block text-sm font-medium text-slate-700 mb-1">Choose Target Folder</label>
                <select id="import-folder-select" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <!-- Folder options will be populated by JS -->
                </select>
            </div>

            <!-- File Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Select File</label>
                <input type="file" id="file-import-input" class="file-input-hidden">
                <label for="file-import-input" class="file-input-label w-full text-center">
                    Click to select a file...
                </label>
                <p id="file-import-filename" class="text-sm text-slate-500 italic mt-2"></p>
            </div>
            
            <!-- AI Content Analyzer (for images) -->
            <div id="ai-analysis-section" class="hidden mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <button id="analyze-file-content-btn" class="flex items-center justify-center w-full text-indigo-600 font-medium hover:text-indigo-800 transition duration-200">
                    <span id="analyze-btn-text">âœ¨ Analyze Content (AI)</span>
                    <div id="analyze-btn-spinner" class="spinner !w-5 !h-5 !border-indigo-500 hidden ml-2"></div>
                </button>
                <div id="ai-analysis-result" class="text-sm text-slate-600 mt-2 hidden"></div>
            </div>

            <!-- File Name -->
            <div class="mb-4">
                <label for="file-import-name" class="block text-sm font-medium text-slate-700 mb-1">Name Your New File</label>
                <input type="text" id="file-import-name" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 'Lab Report.pdf'">
            </div>

            <!-- Conversion Type -->
            <div class="mb-6">
                <label for="file-import-type" class="block text-sm font-medium text-slate-700 mb-1">Convert To (Simulated)</label>
                <select id="file-import-type" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="pdf">PDF</option>
                    <option value="docx">DOCX (Word Document)</option>
                    <option value="img">Image (PNG/JPG)</option>
                    <option value="txt">Text File</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('import-file-modal')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="save-file-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200 flex items-center">
                    <span id="save-file-btn-text">Save & Store</span>
                    <div id="save-file-spinner" class="spinner !w-5 !h-5 !border-white hidden ml-2"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- 
      Add Reminder / Alarm Modal
    -->
    <div id="add-reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">Set Reminder / Alarm</h3>
            
            <!-- Reminder Title & AI Task Breakdown -->
            <div class="mb-4">
                <label for="reminder-title" class="block text-sm font-medium text-slate-700 mb-1">Task Title</label>
                <div class="flex space-x-2">
                    <input type="text" id="reminder-title" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 'Study for Biology Final'">
                    <button id="breakdown-task-btn" title="Break Down Task (AI)" class="p-3 bg-indigo-100 text-indigo-600 hover:bg-indigo-200 rounded-lg transition">
                        âœ¨
                    </button>
                </div>
            </div>

            <!-- AI Task Breakdown Results -->
            <div id="task-breakdown-loading" class="hidden text-center p-2">
                <div class="spinner mx-auto !w-5 !h-5"></div>
            </div>
            <div id="task-breakdown-result" class="hidden mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                <h4 class="font-medium text-sm text-slate-700 mb-1">Suggested Sub-tasks:</h4>
                <ul id="task-breakdown-list" class="list-disc list-inside text-sm text-slate-600 space-y-1">
                    <!-- Sub-tasks from Gemini will be injected here -->
                </ul>
            </div>


            <!-- Due Date / Time -->
            <div class="mb-4">
                <label for="reminder-datetime" class="block text-sm font-medium text-slate-700 mb-1">Due Date / Time</A_LABEL>
                <input type="datetime-local" id="reminder-datetime" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal('add-reminder-modal')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="set-alarm-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200">
                    Set Alarm
                </button>
            </div>
        </div>
    </div>
    
    <!-- 
      Alarm Notification Modal
      This appears when a reminder is due.
    -->
    <div id="alarm-notification-modal" class="fixed top-5 right-5 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50 hidden animate-pulse">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m12 8 0 4"></path><path d="m12 16 0 .01"></path></svg>
            <div>
                <h4 class="font-bold">ALARM!</h4>
                <p id="alarm-notification-title" class="text-sm">Reminder is due!</p>
            </div>
            <button id="dismiss-alarm-btn" class="ml-4 text-red-100 hover:text-white">&times;</button>
        </div>
    </div>


    <!-- 
      File Details Modal
      This appears when a file item is clicked.
    -->
    <div id="file-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="file-details-name" class="text-xl font-semibold text-slate-800 mb-4">File Details</h3>
            
            <div class="space-y-3">
                <p><strong class="text-slate-600">Type:</strong> <span id="file-details-type" class="text-slate-800"></span></p>
                <p><strong class="text-slate-600">Added:</strong> <span id="file-details-date" class="text-slate-800"></span></p>
                
                <div id="file-details-summary-container" class="hidden">
                    <strong class="text-slate-600">AI Summary:</strong>
                    <p id="file-details-summary" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-md border border-slate-200 mt-1"></p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal('file-details-modal')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                    Close
                </button>
                <button id="file-details-open-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-sm transition duration-200">
                    Open File
                </button>
            </div>
        </div>
    </div>


    <!-- 
      ================================================================
      JAVASCRIPT (Firebase & App Logic)
      ================================================================
    -->
    <script type="module">
        // Import Firebase services from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            onSnapshot,
            getDocs, // <-- This was the missing import
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- FIREBASE INITIALIZATION AND CONFIGURATION ---
        
        // ðŸ›‘ This is your specific Firebase configuration.
        // This connects the app to your 'personalfolder-d9ba8' project.
        const firebaseConfig = {
          apiKey: "AIzaSyAa4EpAF0CakYdQsbGxurUNXMwRH9W4IcQ",
          authDomain: "personalfolder-d9ba8.firebaseapp.com",
          projectId: "personalfolder-d9ba8",
          storageBucket: "personalfolder-d9ba8.appspot.com",
          messagingSenderId: "216731617905",
          appId: "1:216731617905:web:fea13d842d3102f7c229d0",
          measurementId: "G-GLWFYE1GW0"
        };
        
        // Set the appId for database paths
        const appId = firebaseConfig.projectId || 'default-app-id';
        // We will sign in anonymously, so no initial token is needed.
        const initialAuthToken = null;
        // This flag will be true, enabling the database functions.
        const isFirebaseAvailable = Object.keys(firebaseConfig).length > 0;

        // Initialize Firebase
        let app, auth, db, storage;
        let userId = null;
        let isAuthReady = false; // Flag to track if auth state is confirmed

        // Global state variables
        let currentView = 'files'; // 'files', 'reminders', 'study-ai'
        let currentFileView = 'folders'; // 'folders', 'files' (sub-view)
        let currentFolderId = null; // The ID of the folder being viewed
        let currentFolderName = null; // The name of the folder being viewed
        let currentStudyImage = null; // { base64, mimeType, fullDataUrl } for Study AI
        let lastStudyAiResult = ""; // To store text for TTS
        let reminderListeners = []; // To store unsubscribe functions for snapshots
        let folderListeners = [];
        let fileListeners = [];
        let alarmedReminders = new Set(); // To track reminders that have already alarmed
        let localFolderCache = new Map(); // Cache for folder data

        // DOM Element References
        const initializingView = document.getElementById('initializing-view');
        const offlineWarning = document.getElementById('offline-warning');
        const offlineMessage = document.getElementById('offline-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const tabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Folder View Elements
        const filesSection = document.getElementById('files-section');
        const folderListView = document.getElementById('folder-list-view');
        const folderListContainer = document.getElementById('folder-list-container');
        const noFoldersMessage = document.getElementById('no-folders-message');
        const showFolderModalBtn = document.getElementById('show-folder-modal-btn');
        const showQuickImportModalBtn = document.getElementById('show-quick-import-modal-btn');

        // File View Elements
        const fileListView = document.getElementById('file-list-view');
        const fileListContainer = document.getElementById('file-list-container');
        const noFilesMessage = document.getElementById('no-files-message');
        const backToFoldersBtn = document.getElementById('back-to-folders-btn');
        const currentFolderNameEl = document.getElementById('current-folder-name');
        const showImportModalFromFileViewBtn = document.getElementById('show-import-modal-from-file-view-btn');

        // Reminders View Elements
        const remindersSection = document.getElementById('reminders-section');
        const remindersListContainer = document.getElementById('reminders-list-container');
        const noRemindersMessage = document.getElementById('no-reminders-message');
        const showReminderModalBtn = document.getElementById('show-reminder-modal-btn');

        // Study AI View Elements
        const studyAiSection = document.getElementById('study-ai-section');
        const studyAiInput = document.getElementById('study-ai-input');
        const studyAiAskBtn = document.getElementById('study-ai-ask-btn');
        const studyAiLoading = document.getElementById('study-ai-loading');
        const studyAiOutput = document.getElementById('study-ai-output');
        const studyAiResultHeader = document.getElementById('study-ai-result-header');
        const studyAiSources = document.getElementById('study-ai-sources');
        const studyAiSourcesList = document.getElementById('study-ai-sources-list');
        const studyAiImageInput = document.getElementById('study-ai-image-input');
        const studyAiImageFilename = document.getElementById('study-ai-image-filename');
        const studyAiImagePreview = document.getElementById('study-ai-image-preview');

        // AI TTS Elements
        const studyAiSpeakBtn = document.getElementById('study-ai-speak-btn');
        const studyAiSpeakBtnText = document.getElementById('study-ai-speak-btn-text');
        const studyAiSpeakBtnSpinner = document.getElementById('study-ai-speak-btn-spinner');

        // Create Folder Modal Elements
        const createFolderModal = document.getElementById('create-folder-modal');
        const folderNameInput = document.getElementById('folder-name-input');
        const createFolderBtn = document.getElementById('create-folder-btn');

        // Import File Modal Elements
        const importFileModal = document.getElementById('import-file-modal');
        const importFolderSelectContainer = document.getElementById('import-folder-select-container');
        const importFolderSelect = document.getElementById('import-folder-select');
        const fileImportInput = document.getElementById('file-import-input');
        const fileImportFilename = document.getElementById('file-import-filename');
        const fileImportName = document.getElementById('file-import-name');
        const fileImportType = document.getElementById('file-import-type');
        const saveFileBtn = document.getElementById('save-file-btn');
        const saveFileBtnText = document.getElementById('save-file-btn-text');
        const saveFileSpinner = document.getElementById('save-file-spinner');
        const aiAnalysisSection = document.getElementById('ai-analysis-section');
        const analyzeFileContentBtn = document.getElementById('analyze-file-content-btn');
        const analyzeBtnText = document.getElementById('analyze-btn-text');
        const analyzeBtnSpinner = document.getElementById('analyze-btn-spinner');
        const aiAnalysisResult = document.getElementById('ai-analysis-result');
        let fileToUpload = null; // Store the file object for upload

        // Add Reminder Modal Elements
        const addReminderModal = document.getElementById('add-reminder-modal');
        const reminderTitle = document.getElementById('reminder-title');
        const reminderDatetime = document.getElementById('reminder-datetime');
        const setAlarmBtn = document.getElementById('set-alarm-btn');
        const breakdownTaskBtn = document.getElementById('breakdown-task-btn');
        const taskBreakdownLoading = document.getElementById('task-breakdown-loading');
        const taskBreakdownResult = document.getElementById('task-breakdown-result');
        const taskBreakdownList = document.getElementById('task-breakdown-list');
        let currentSubTasks = []; // Store AI-generated sub-tasks

        // Alarm Notification Elements
        const alarmNotificationModal = document.getElementById('alarm-notification-modal');
        const alarmNotificationTitle = document.getElementById('alarm-notification-title');
        const dismissAlarmBtn = document.getElementById('dismiss-alarm-btn');
        
        // File Details Modal Elements
        const fileDetailsModal = document.getElementById('file-details-modal');
        const fileDetailsName = document.getElementById('file-details-name');
        const fileDetailsType = document.getElementById('file-details-type');
        const fileDetailsDate = document.getElementById('file-details-date');
        const fileDetailsSummaryContainer = document.getElementById('file-details-summary-container');
        const fileDetailsSummary = document.getElementById('file-details-summary');
        const fileDetailsOpenBtn = document.getElementById('file-details-open-btn');
        let fileDetailsUrl = null; // Store URL for the "Open" button
        

        // --- CORE FUNCTIONS ---

        /**
         * Shows a modal dialog.
         * @param {string} modalId - The ID of the modal element to show.
         */
        const showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        };
        // Expose to window for inline onclick attributes
        window.showModal = showModal;


        /**
         * Hides a modal dialog.
         * @param {string} modalId - The ID of the modal element to hide.
         */
        const hideModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        };
        // Expose to window for inline onclick attributes
        window.hideModal = hideModal;


        /**
         * Displays a simple alert message (replaces native alert).
         * @param {string} message - The message to display.
         */
        const showAppAlert = (message) => {
            // In a real app, this would be a styled modal.
            // For now, we'll use the offline warning bar.
            console.warn(message);
            offlineMessage.textContent = message;
            offlineWarning.classList.remove('hidden');
            offlineWarning.classList.replace('bg-red-100', 'bg-yellow-100');
            offlineWarning.classList.replace('border-red-500', 'border-yellow-500');
            offlineWarning.classList.replace('text-red-700', 'text-yellow-700');
            
            setTimeout(() => {
                offlineWarning.classList.add('hidden');
                // Reset styles
                offlineWarning.classList.replace('bg-yellow-100', 'bg-red-100');
                offlineWarning.classList.replace('border-yellow-500', 'border-red-500');
                offlineWarning.classList.replace('text-yellow-700', 'text-red-700');
            }, 3000);
        };


        /**
         * Switches the main content view between tabs.
         * @param {string} tabName - The name of the tab to switch to ('files', 'reminders', 'study-ai').
         */
        const switchTab = (tabName) => {
            currentView = tabName;
            
            // Update tab button styles
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('text-indigo-600', 'border-indigo-600');
                    tab.classList.remove('text-slate-500');
                } else {
                    tab.classList.add('text-slate-500');
                    tab.classList.remove('text-indigo-600', 'border-indigo-600');
                }
            });

            // Show/hide tab content
            tabContents.forEach(content => {
                if (content.id === `${tabName}-section`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Hide initializing view
            initializingView.classList.add('hidden');
        };

        /**
         * Switches the file view between folders list and file list.
         * @param {string} viewName - 'folders' or 'files'.
         */
        const switchFileView = (viewName) => {
            currentFileView = viewName;
            if (viewName === 'files') {
                folderListView.classList.add('hidden');
                fileListView.classList.remove('hidden');
                // Fetch and render files for the currentFolderId
                fetchFiles(currentFolderId);
            } else {
                currentFolderId = null;
                currentFolderName = null;
                folderListView.classList.remove('hidden');
                fileListView.classList.add('hidden');
                // Detach old file listeners
                detachListeners(fileListeners);
            }
        };

        /**
         * Detaches all active Firestore listeners.
         * @param {Array<Function>} listenerArray - The array of unsubscribe functions.
         */
        const detachListeners = (listenerArray) => {
            listenerArray.forEach(unsubscribe => unsubscribe());
            listenerArray.length = 0; // Clear the array
        };


        // --- FIREBASE & DATA FUNCTIONS ---

        /**
         * Initializes Firebase and sets up authentication.
         */
        const initializeAppAndAuth = () => {
            if (!isFirebaseAvailable) {
                console.error("Firebase config is missing. Running in OFFLINE MODE.");
                offlineWarning.classList.remove('hidden');
                // Force UI to render in offline state
                userIdDisplay.textContent = "User ID: OFFLINE";
                isAuthReady = true;
                switchTab('files'); // Show default tab
                switchFileView('folders'); // Show default sub-view
                renderFolders([]); // Show empty folders list
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in anonymously
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                        console.log("User signed in anonymously:", userId);

                        if (!isAuthReady) {
                            isAuthReady = true;
                            // This is the first successful auth
                            initializeAppUI();
                        }
                    } else {
                        // User is signed out
                        userId = null;
                        isAuthReady = false;
                        userIdDisplay.textContent = "User ID: N/A";
                        console.log("User is signed out. Attempting to sign in...");
                        // Try to sign in again
                        signInAnonymously(auth).catch(handleFirebaseError);
                    }
                });

                // Initial sign-in attempt
                if (initialAuthToken) {
                    // This path is for the canvas environment
                    console.log("Signing in with custom token...");
                    signInWithCustomToken(auth, initialAuthToken).catch(handleFirebaseError);
                } else {
                    // This path is for GitHub Pages
                    console.log("Signing in anonymously...");
                    signInAnonymously(auth).catch(handleFirebaseError);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                handleFirebaseError(error);
            }
        };

        /**
         * Handles Firebase errors and displays them.
         * @param {Error} error - The error object from Firebase.
         */
        const handleFirebaseError = (error) => {
            console.error("Firebase Error:", error.code, error.message);
            
            let userMessage = `Error: ${error.message}`;
            if (error.code === 'auth/operation-not-allowed') {
                userMessage = "Error: Anonymous sign-in is not enabled. Please enable it in the Firebase console (Authentication > Sign-in method).";
            } else if (error.code === 'permission-denied') {
                userMessage = "Error: Insufficient permissions. Please check your Firestore or Storage security rules.";
            }

            offlineMessage.textContent = userMessage;
            offlineWarning.classList.remove('hidden');
            
            // Force UI to render even if auth fails, to prevent "Initializing..." hang
            if (!isAuthReady) {
                isAuthReady = true; // Mark as "ready" to stop loops
                userIdDisplay.textContent = "User ID: ERROR";
                switchTab('files');
                switchFileView('folders');
                renderFolders([]);
            }
        };

        /**
         * Sets up the main application UI after auth is ready.
         */
        const initializeAppUI = () => {
            if (!isAuthReady || !userId) return;

            console.log("Initializing UI and fetching data...");
            
            // Setup tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Set default view
            switchTab('files');
        
            // Fetch initial data
            fetchFolders();
            fetchReminders();
            
            // Start reminder check interval
            setInterval(checkReminders, 60000); // Check every 60 seconds
        };

        // --- FOLDER MANAGEMENT ---

        /**
         * Fetches the user's folders from Firestore and sets up a realtime listener.
         */
        const fetchFolders = () => {
            if (!isFirebaseAvailable || !userId) return;
            
            detachListeners(folderListeners); // Clear old listeners
            
            const foldersCol = collection(db, 'artifacts', appId, 'users', userId, 'folders');
            const q = query(foldersCol);

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const folders = [];
                localFolderCache.clear();
                querySnapshot.forEach((doc) => {
                    const folder = { id: doc.id, ...doc.data() };
                    folders.push(folder);
                    localFolderCache.set(folder.id, folder); // Update cache
                });
                renderFolders(folders);
                populateFolderSelect(folders); // Update dropdowns
            }, (error) => {
                handleFirebaseError(error);
                renderFolders([]); // Show empty list on error
            });
            
            folderListeners.push(unsubscribe);
        };

        /**
         * Renders the list of folders in the UI.
         * @param {Array} folders - An array of folder objects.
         */
        const renderFolders = (folders) => {
            folderListContainer.innerHTML = ''; // Clear existing list
            
            if (folders.length === 0) {
                noFoldersMessage.classList.remove('hidden');
            } else {
                noFoldersMessage.classList.add('hidden');
                // Sort folders alphabetically by name
                folders.sort((a, b) => a.name.localeCompare(b.name));
                
                folders.forEach(folder => {
                    const folderEl = document.createElement('div');
                    folderEl.className = 'folder-item bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 transition duration-150';
                    folderEl.dataset.id = folder.id;
                    folderEl.dataset.name = folder.name;
                    
                    folderEl.innerHTML = `
                        <div class="flex items-center min-w-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500 flex-shrink-0"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                            <span class="ml-3 font-medium text-slate-700 truncate">${folder.name}</span>
                        </div>
                        <button class="delete-folder-btn text-red-400 hover:text-red-600 p-1 rounded-full transition duration-150" data-id="${folder.id}" title="Delete folder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    
                    // Click listener for the folder item (but not the button)
                    folderEl.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-folder-btn')) {
                            handleFolderClick(folder.id, folder.name);
                        }
                    });
                    
                    // Click listener for the delete button
                    folderEl.querySelector('.delete-folder-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent folder click
                        handleDeleteFolder(folder.id, folder.name);
                    });
                    
                    folderListContainer.appendChild(folderEl);
                });
            }
        };

        /**
         * Populates the folder <select> dropdown in the import modal.
         * @param {Array} folders - An array of folder objects.
         */
        const populateFolderSelect = (folders) => {
            importFolderSelect.innerHTML = '<option value="">Select a folder...</option>'; // Clear and add default
            // Sort folders alphabetically
            folders.sort((a, b) => a.name.localeCompare(b.name));
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                importFolderSelect.appendChild(option);
            });
        };

        /**
         * Handles the creation of a new folder.
         */
        const handleCreateFolder = async () => {
            if (!isFirebaseAvailable || !userId) {
                return showAppAlert("Cannot create folder. Database not connected.");
            }
            
            const folderName = folderNameInput.value.trim();
            if (!folderName) {
                return showAppAlert("Please enter a folder name.");
            }

            try {
                const foldersCol = collection(db, 'artifacts', appId, 'users', userId, 'folders');
                await addDoc(foldersCol, {
                    name: folderName,
                    createdAt: Timestamp.now()
                });
                
                folderNameInput.value = '';
                hideModal('create-folder-modal');
                
            } catch (error) {
                handleFirebaseError(error);
                showAppAlert("Failed to create folder.");
            }
        };

        /**
         * Handles clicking on a folder to view its contents.
         * @param {string} folderId - The ID of the clicked folder.
         * @param {string} folderName - The name of the clicked folder.
         */
        const handleFolderClick = (folderId, folderName) => {
            currentFolderId = folderId;
            currentFolderName = folderName;
            currentFolderNameEl.textContent = folderName;
            switchFileView('files');
        };

        /**
         * Handles deleting a folder (and its contents, TBD).
         * @param {string} folderId - The ID of the folder to delete.
         * @param {string} folderName - The name of the folder (for confirmation).
         */
        const handleDeleteFolder = async (folderId, folderName) => {
            // Note: window.confirm is bad UX, replace with a custom modal in a real app
            // For now, we'll skip confirmation to avoid `confirm()`
            // const isConfirmed = confirm(`Are you sure you want to delete "${folderName}"? This cannot be undone.`);
            // if (!isConfirmed) return;
            
            // TODO: In a real app, we must also delete all files *inside* this folder,
            // which requires deleting from both Firestore and Firebase Storage (a complex operation).
            // For now, we'll just delete the folder document.

            if (!isFirebaseAvailable || !userId) {
                return showAppAlert("Cannot delete folder. Database not connected.");
            }

            try {
                const folderDoc = doc(db, 'artifacts', appId, 'users', userId, 'folders', folderId);
                await deleteDoc(folderDoc);
                console.log(`Folder ${folderId} deleted.`);
            } catch (error) {
                handleFirebaseError(error);
                showAppAlert("Failed to delete folder.");
            }
        };


        // --- FILE MANAGEMENT ---

        /**
         * Fetches files for a specific folder from Firestore.
         * @param {string} folderId - The ID of the folder.
         */
        const fetchFiles = (folderId) => {
            if (!isFirebaseAvailable || !userId || !folderId) return;

            detachListeners(fileListeners); // Clear old listeners
            
            const filesCol = collection(db, 'artifacts', appId, 'users', userId, 'files');
            const q = query(filesCol, where("folderId", "==", folderId));

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const files = [];
                querySnapshot.forEach((doc) => {
                    files.push({ id: doc.id, ...doc.data() });
                });
                renderFiles(files);
            }, (error) => {
                handleFirebaseError(error);
                renderFiles([]);
            });
            
            fileListeners.push(unsubscribe);
        };

        /**
         * Renders the list of files in the UI.
         * @param {Array} files - An array of file objects.
         */
        const renderFiles = (files) => {
            fileListContainer.innerHTML = ''; // Clear existing list
            
            if (files.length === 0) {
                noFilesMessage.classList.remove('hidden');
            } else {
                noFilesMessage.classList.add('hidden');
                
                // Sort files by creation date, newest first
                files.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                
                files.forEach(file => {
                    const fileEl = document.createElement('div');
                    fileEl.className = 'file-item bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 transition duration-150';
                    // Store all data on the element for the details modal
                    fileEl.dataset.id = file.id;
                    fileEl.dataset.name = file.name;
                    fileEl.dataset.type = file.type;
                    fileEl.dataset.url = file.downloadURL;
                    fileEl.dataset.summary = file.aiSummary || '';
                    fileEl.dataset.date = file.createdAt.toDate().toLocaleString();

                    // Get appropriate icon based on file type
                    let iconSvg = '';
                    switch(file.type) {
                        case 'pdf':
                            iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 flex-shrink-0"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M10 11v6"></path><path d="M13 11v6"></path><path d="M7 11v6"></path></svg>';
                            break;
                        case 'docx':
                            iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 flex-shrink-0"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M10.4 12.6c.2-1.2 1.5-2.6 2.6-2.6 1.8 0 2.6 1.8 2.6 3 0 2.8-2.2 4-3.9 4-1.4 0-2.6-.9-2.6-2.1 0-1.1.9-1.9 2.1-1.9H12"></path></svg>';
                            break;
                        case 'img':
                            iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500 flex-shrink-0"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
                            break;
                        default:
                            iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 flex-shrink-0"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>';
                    }

                    fileEl.innerHTML = `
                        <div class="flex items-center min-w-0">
                            ${iconSvg}
                            <span class="ml-3 font-medium text-slate-700 truncate">${file.name}</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><path d="m9 18 6-6-6-6"/></svg>
                    `;
                    
                    // Click listener to open file details
                    fileEl.addEventListener('click', () => {
                        handleFileClick(fileEl.dataset);
                    });
                    
                    fileListContainer.appendChild(fileEl);
                });
            }
        };


        /**
         * Clears and resets the import file modal to its default state.
         */
        const resetImportModal = () => {
            fileImportInput.value = null;
            fileToUpload = null;
            fileImportFilename.textContent = '';
            fileImportName.value = '';
            fileImportType.value = 'pdf';
            importFolderSelect.value = '';
            aiAnalysisSection.classList.add('hidden');
            aiAnalysisResult.classList.add('hidden');
            aiAnalysisResult.textContent = '';
            analyzeBtnText.textContent = 'âœ¨ Analyze Content (AI)';
            analyzeBtnSpinner.classList.add('hidden');
            saveFileBtn.disabled = false;
            saveFileBtnText.textContent = 'Save & Store';
            saveFileSpinner.classList.add('hidden');
        };
        
        /**
         * Prepares and shows the import file modal.
         * This is called by "Quick Import" (no folderId) or "Import File" (with folderId).
         * @param {string|null} folderId - The ID of the folder (if already inside one).
         */
        const showImportModal = (folderId = null) => {
            resetImportModal();
            
            // This is the logic update:
            // Hide the folder selector if we are already inside a folder.
            if (folderId) {
                importFolderSelectContainer.style.display = 'none';
                // The folderId is already set by `currentFolderId`
            } else {
                // We are at the root, show the selector
                importFolderSelectContainer.style.display = 'block';
                // Make sure `currentFolderId` is null
                currentFolderId = null; 
            }
            
            showModal('import-file-modal');
        };

        /**
         * Handles the file selection in the import modal.
         * @param {Event} e - The file input change event.
         */
        const handleFileSelection = (e) => {
            if (e.target.files && e.target.files.length > 0) {
                fileToUpload = e.target.files[0];
                fileImportFilename.textContent = fileToUpload.name;
                
                // Suggest a file name (remove original extension)
                const nameWithoutExt = fileToUpload.name.split('.').slice(0, -1).join('.');
                fileImportName.value = nameWithoutExt;
                
                // If it's an image, show the AI analysis button
                if (fileToUpload.type.startsWith('image/')) {
                    aiAnalysisSection.classList.remove('hidden');
                    aiAnalysisResult.classList.add('hidden');
                    aiAnalysisResult.textContent = '';
                } else {
                    aiAnalysisSection.classList.add('hidden');
                }
            } else {
                fileToUpload = null;
                fileImportFilename.textContent = '';
                aiAnalysisSection.classList.add('hidden');
            }
        };

        /**
         * Handles the saving of an imported file.
         */
        const handleSaveFile = async () => {
            if (!isFirebaseAvailable || !userId) {
                return showAppAlert("Cannot save file. Database not connected.");
            }
            
            // Determine the target folder ID
            let targetFolderId = currentFolderId; // Will be set if importing from *inside* a folder
            if (!targetFolderId) { 
                // If at root, get it from the dropdown
                targetFolderId = importFolderSelect.value;
            }

            const newFileName = fileImportName.value.trim();
            const newFileType = fileImportType.value;

            // Validation
            if (!targetFolderId) return showAppAlert("Please select a target folder.");
            if (!fileToUpload) return showAppAlert("Please select a file to upload.");
            if (!newFileName) return showAppAlert("Please enter a name for the new file.");

            // Show loading state
            saveFileBtn.disabled = true;
            saveFileBtnText.textContent = 'Uploading...';
            saveFileSpinner.classList.remove('hidden');
            
            try {
                // --- 1. Upload File to Firebase Storage ---
                const storagePath = `artifacts/${appId}/users/${userId}/files/${Date.now()}-${fileToUpload.name}`;
                const storageRef = ref(storage, storagePath);
                
                console.log(`Uploading to ${storagePath}...`);
                const uploadResult = await uploadBytes(storageRef, fileToUpload);
                const downloadURL = await getDownloadURL(uploadResult.ref);
                console.log("File uploaded successfully. URL:", downloadURL);

                // --- 2. Save Metadata to Firestore ---
                const filesCol = collection(db, 'artifacts', appId, 'users', userId, 'files');
                await addDoc(filesCol, {
                    folderId: targetFolderId,
                    name: newFileName,
                    type: newFileType,
                    originalName: fileToUpload.name,
                    storagePath: storagePath,
                    downloadURL: downloadURL,
                    aiSummary: aiAnalysisResult.textContent || '',
                    createdAt: Timestamp.now()
                });

                // --- 3. Finish ---
                hideModal('import-file-modal');
                // If we were in the file view, the onSnapshot listener will
                // automatically refresh the list.
                // If we were in the folder view, we don't need to do anything.

            } catch (error) {
                handleFirebaseError(error);
                showAppAlert("Failed to save file. Check console and storage rules.");
            } finally {
                // Hide loading state
                saveFileBtn.disabled = false;
                saveFileBtnText.textContent = 'Save & Store';
                saveFileSpinner.classList.add('hidden');
            }
        };

        /**
         * Handles clicking on a file in the list.
         * Opens the file in a new tab for viewing.
         * @param {DOMStringMap} fileData - The dataset from the file element.
         */
        const handleFileClick = (fileData) => {
            const fileUrl = fileData.url;
            if (!fileUrl) {
                return showAppAlert("This file has no URL and cannot be opened.");
            }
            
            // This is the "Open" (not "Download") logic
            // It will open the file in a new tab.
            // This works for images, PDFs, text, etc.
            // It might be blocked by pop-up blockers!
            try {
                window.open(fileUrl, '_blank');
            } catch (e) {
                console.error("Failed to open new tab:", e);
                showAppAlert("Could not open file. Pop-up may be blocked.");
            }
        };


        // --- REMINDER MANAGEMENT & ALARM ---

        /**
         * Fetches all reminders from Firestore and listens for changes.
         */
        const fetchReminders = () => {
            if (!isFirebaseAvailable || !userId) return;
            
            detachListeners(reminderListeners);
            
            const remindersCol = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
            const q = query(remindersCol);

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const reminders = [];
                querySnapshot.forEach((doc) => {
                    reminders.push({ id: doc.id, ...doc.data() });
                });
                renderReminders(reminders);
                checkReminders(reminders); // Check immediately on new data
            }, (error) => {
                handleFirebaseError(error);
                renderReminders([]);
            });
            
            reminderListeners.push(unsubscribe);
        };

        /**
         * Renders the list of reminders in the UI.
         * @param {Array} reminders - An array of reminder objects.
         */
        const renderReminders = (reminders) => {
            remindersListContainer.innerHTML = '';
            
            if (reminders.length === 0) {
                noRemindersMessage.classList.remove('hidden');
            } else {
                noRemindersMessage.classList.add('hidden');
                
                // Sort by due date, earliest first
                reminders.sort((a, b) => a.dueAt.toMillis() - b.dueAt.toMillis());
                
                reminders.forEach(reminder => {
                    const reminderEl = document.createElement('div');
                    reminderEl.className = 'bg-white p-4 rounded-lg shadow-sm relative';
                    
                    const dueDate = reminder.dueAt.toDate();
                    const isOverdue = dueDate < new Date();
                    
                    let subTaskHtml = '';
                    if (reminder.subTasks && reminder.subTasks.length > 0) {
                        subTaskHtml = `
                            <div class="mt-2 pt-2 pl-4 border-l-2 border-indigo-200 space-y-1">
                                ${reminder.subTasks.map(task => `<p class="text-sm text-slate-600">- ${task}</p>`).join('')}
                            </div>
                        `;
                    }
                    
                    reminderEl.innerHTML = `
                        <button class="delete-reminder-btn absolute top-2 right-2 text-red-400 hover:text-red-600 p-1 rounded-full transition" data-id="${reminder.id}" title="Delete reminder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                        <p class="font-semibold text-slate-800 pr-6">${reminder.title}</p>
                        <p class="text-sm ${isOverdue ? 'text-red-500 font-medium' : 'text-slate-500'}">
                            Due: ${dueDate.toLocaleString()} ${isOverdue ? '(Overdue)' : ''}
                        </p>
                        ${subTaskHtml}
                    `;
                    
                    reminderEl.querySelector('.delete-reminder-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeleteReminder(reminder.id);
                    });
                    
                    remindersListContainer.appendChild(reminderEl);
                });
            }
        };
        
        /**
         * Clears and resets the add reminder modal.
         */
        const resetReminderModal = () => {
            reminderTitle.value = '';
            reminderDatetime.value = '';
            taskBreakdownLoading.classList.add('hidden');
            taskBreakdownResult.classList.add('hidden');
            taskBreakdownList.innerHTML = '';
            currentSubTasks = [];
        };

        /**
         * Handles setting a new reminder.
         */
        const handleSetAlarm = async () => {
            if (!isFirebaseAvailable || !userId) {
                return showAppAlert("Cannot set reminder. Database not connected.");
            }

            const title = reminderTitle.value.trim();
            const datetime = reminderDatetime.value;

            if (!title || !datetime) {
                return showAppAlert("Please enter a title and a due date/time.");
            }

            try {
                const dueAt = new Date(datetime);
                const remindersCol = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                
                await addDoc(remindersCol, {
                    title: title,
                    dueAt: Timestamp.fromDate(dueAt),
                    subTasks: currentSubTasks, // Add the AI-generated sub-tasks
                    createdAt: Timestamp.now()
                });

                resetReminderModal();
                hideModal('add-reminder-modal');
                
            } catch (error) {
                handleFirebaseError(error);
                showAppAlert("Failed to set reminder.");
            }
        };
        
        /**
         * Handles deleting a reminder.
         * @param {string} reminderId - The ID of the reminder to delete.
         */
        const handleDeleteReminder = async (reminderId) => {
            if (!isFirebaseAvailable || !userId) {
                return showAppAlert("Cannot delete reminder. Database not connected.");
            }
            
            try {
                const reminderDoc = doc(db, 'artifacts', appId, 'users', userId, 'reminders', reminderId);
                await deleteDoc(reminderDoc);
                console.log(`Reminder ${reminderId} deleted.`);
            } catch (error) {
                handleFirebaseError(error);
                showAppAlert("Failed to delete reminder.");
            }
        };

        /**
         * Checks all reminders to see if any are due.
         * @param {Array} reminders - An array of reminder objects (optional).
         */
        const checkReminders = async (reminders = null) => {
            if (!isFirebaseAvailable || !userId) return;

            // If reminders aren't passed in, fetch them manually.
            // This is for the setInterval check.
            if (!reminders) {
                try {
                    const remindersCol = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                    const snapshot = await getDocs(remindersCol);
                    reminders = [];
                    snapshot.forEach(doc => reminders.push({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    handleFirebaseError(error);
                    return;
                }
            }

            const now = new Date();
            
            reminders.forEach(reminder => {
                const dueAt = reminder.dueAt.toDate();
                // Check if due, not already alarmed, and not in the distant past (e.g., > 1 day old)
                const isOverdue = dueAt <= now;
                const isNotAlarmed = !alarmedReminders.has(reminder.id);
                const isRecent = (now - dueAt) < (24 * 60 * 60 * 1000); // Within last 24 hours

                if (isOverdue && isNotAlarmed && isRecent) {
                    console.log("ALARM TRIGGERED:", reminder.title);
                    playBeepAlarm();
                    alarmNotificationTitle.textContent = reminder.title;
                    alarmNotificationModal.classList.remove('hidden');
                    alarmedReminders.add(reminder.id); // Mark as alarmed
                }
            });
        };
        
        /**
         * Plays a beep-beep sound using the Web Audio API.
         */
        const playBeepAlarm = () => {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const playBeep = (startTime, freq) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, startTime);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, startTime + 0.01); // Quick attack
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, startTime + 0.15); // Decay
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.15);
                };

                const now = audioContext.currentTime;
                playBeep(now, 880); // First beep
                playBeep(now + 0.2, 880); // Second beep
                
            } catch (error) {
                console.error("Web Audio API error:", error);
                // Fallback for browsers that might block it
            }
        };


        // --- GEMINI AI FUNCTIONS ---

        // Gemini API Configuration
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models";
        // NOTE: The API Key is intentionally left as an empty string.
        // The host environment (Canvas) will inject the necessary key.
        const GEMINI_API_KEY = ""; 
        const GEMINI_TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_TTS_MODEL = "gemini-2.5-flash-preview-tts";

        /**
         * Utility function to handle exponential backoff for API retries.
         * @param {Function} apiCallFunction - The async function to call (e.g., fetch).
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<any>} - The result of the successful API call.
         */
        const fetchWithExponentialBackoff = async (apiCallFunction, maxRetries = 5) => {
            let attempt = 0;
            let delay = 1000; // Start with 1 second

            while (attempt < maxRetries) {
                try {
                    const response = await apiCallFunction();
                    if (!response.ok) {
                        // Handle non-transient errors (like 400 Bad Request) immediately
                        if (response.status >= 400 && response.status < 500) {
                            console.error(`API Error ${response.status}:`, await response.json());
                            throw new Error(`API request failed: ${response.statusText}`);
                        }
                        // Handle server-side or rate-limiting errors (like 5xx, 429)
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    return await response.json(); // Success
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        console.error("API call failed after max retries.");
                        throw error; // Rethrow the last error
                    }
                    console.warn(`API call attempt ${attempt} failed. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        };

        /**
         * Generic function to call the Gemini generateContent API.
         * @param {string} model - The model name (e.g., 'gemini-2.5-flash-preview-09-2025').
         * @param {object} payload - The request payload.
         * @returns {Promise<object>} - The parsed JSON response.
         */
        const callGeminiApi = async (model, payload) => {
            const apiUrl = `${GEMINI_API_URL}/${model}:generateContent?key=${GEMINI_API_KEY}`;
            
            return fetchWithExponentialBackoff(async () => {
                return fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            });
        };
        
        /**
         * Converts an image file to Base64 and returns mime type and data.
         * @param {File} file - The image file.
         * @returns {Promise<{base64: string, mimeType: string, fullDataUrl: string}>}
         */
        const base64EncodeImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const fullDataUrl = reader.result;
                    const [header, base64Data] = fullDataUrl.split(',');
                    const mimeType = header.match(/:(.*?);/)[1];
                    resolve({ base64: base64Data, mimeType, fullDataUrl });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        /**
         * Handles the Study AI query (both text and multimodal).
         */
        const handleStudyQuery = async () => {
            const prompt = studyAiInput.value.trim();
            if (!prompt && !currentStudyImage) {
                return showAppAlert("Please enter a question or upload an image.");
            }

            // Show loading
            studyAiLoading.classList.remove('hidden');
            studyAiOutput.innerHTML = '';
            studyAiResultHeader.classList.add('hidden');
            studyAiSources.classList.add('hidden');
            studyAiSourcesList.innerHTML = '';
            studyAiAskBtn.disabled = true;
            studyAiSpeakBtn.classList.add('hidden');
            lastStudyAiResult = "";

            try {
                let payload;
                let useGrounding = false;

                // System instruction for the AI
                const systemInstruction = {
                    parts: [{
                        text: "You are a friendly and knowledgeable student tutor. Answer the user's question clearly and concisely. If it's a complex topic, provide a definition or a short, actionable study plan. Use simple language."
                    }]
                };

                if (currentStudyImage) {
                    // --- Multimodal Query (Image + Text) ---
                    payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: currentStudyImage.mimeType,
                                        data: currentStudyImage.base64
                                    }
                                }
                            ]
                        }],
                        systemInstruction: systemInstruction
                    };
                } else {
                    // --- Text-Only Query (with Grounding) ---
                    useGrounding = true;
                    payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: systemInstruction
                    };
                }

                const result = await callGeminiApi(GEMINI_TEXT_MODEL, payload);

                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    // Sanitize and format text (simple markdown to HTML)
                    let html = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>');

                    studyAiOutput.innerHTML = html;
                    studyAiResultHeader.classList.remove('hidden');
                    lastStudyAiResult = text; // Save for TTS
                    studyAiSpeakBtn.classList.remove('hidden');

                    // Handle grounding (citations)
                    if (useGrounding) {
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                            
                            if (sources.length > 0) {
                                sources.forEach(source => {
                                    const li = document.createElement('li');
                                    li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-600 hover:underline">${source.title}</a>`;
                                    studyAiSourcesList.appendChild(li);
                                });
                                studyAiSources.classList.remove('hidden');
                            }
                        }
                    }
                } else {
                    showAppAlert("The AI returned an empty response.");
                }

            } catch (error) {
                console.error("Gemini AI Error:", error);
                showAppAlert("Failed to get AI response. Check console for details.");
            } finally {
                // Hide loading
                studyAiLoading.classList.add('hidden');
                studyAiAskBtn.disabled = false;
                // Reset image
                currentStudyImage = null;
                studyAiImageInput.value = null;
                studyAiImageFilename.textContent = 'Upload an image (optional)';
                studyAiImagePreview.classList.add('hidden');
            }
        };

        /**
         * Handles image selection for the Study AI.
         */
        const handleStudyAiImageSelect = async (e) => {
            if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];
                try {
                    const { base64, mimeType, fullDataUrl } = await base64EncodeImage(file);
                    currentStudyImage = { base64, mimeType, fullDataUrl };
                    studyAiImageFilename.textContent = file.name;
                    studyAiImagePreview.src = fullDataUrl;
                    studyAiImagePreview.classList.remove('hidden');
                } catch (error) {
                    console.error("Image encoding error:", error);
                    showAppAlert("Failed to read image file.");
                }
            }
        };

        /**
         * Calls Gemini AI to analyze file content (for import modal).
         */
        const handleAnalyzeFileContent = async () => {
            if (!fileToUpload || !fileToUpload.type.startsWith('image/')) {
                return showAppAlert("Please select an image file first.");
            }

            analyzeBtnText.textContent = 'Analyzing...';
            analyzeBtnSpinner.classList.remove('hidden');
            aiAnalysisResult.classList.add('hidden');
            analyzeFileContentBtn.disabled = true;

            try {
                const { base64, mimeType } = await base64EncodeImage(fileToUpload);
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: "Analyze this image (which is a photo of notes, a slide, or a document). Provide a brief 1-sentence summary of the content and suggest a good, academic-style filename (e.g., 'Chem_Lab_Titration_Diagram'). Return ONLY a JSON object with keys 'summary' and 'filename'." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const result = await callGeminiApi(GEMINI_TEXT_MODEL, payload);

                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const data = JSON.parse(jsonText);
                    
                    if (data.summary && data.filename) {
                        aiAnalysisResult.textContent = `Summary: ${data.summary}`;
                        aiAnalysisResult.classList.remove('hidden');
                        fileImportName.value = data.filename; // Auto-fill the filename
                    } else {
                        throw new Error("AI response did not contain 'summary' or 'filename'.");
                    }
                } else {
                    throw new Error("AI returned an empty response.");
                }

            } catch (error) {
                console.error("Gemini Analysis Error:", error);
                showAppAlert("Failed to analyze image content.");
            } finally {
                analyzeBtnText.textContent = 'âœ¨ Analyze Content (AI)';
                analyzeBtnSpinner.classList.add('hidden');
                analyzeFileContentBtn.disabled = false;
            }
        };

        /**
         * Calls Gemini AI to break down a reminder task.
         */
        const handleTaskBreakdown = async () => {
            const title = reminderTitle.value.trim();
            if (!title) {
                return showAppAlert("Please enter a task title first.");
            }
            
            taskBreakdownLoading.classList.remove('hidden');
            taskBreakdownResult.classList.add('hidden');
            taskBreakdownList.innerHTML = '';
            breakdownTaskBtn.disabled = true;
            currentSubTasks = [];
            
            try {
                const payload = {
                    contents: [{
                        parts: [{
                            text: `Break down this complex student task into 3-5 simple, actionable sub-tasks: "${title}".
                            Return ONLY a valid JSON array of strings.
                            Example: ["Research topic", "Create outline", "Write first draft", "Proofread"]`
                        }]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };
                
                const result = await callGeminiApi(GEMINI_TEXT_MODEL, payload);
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const subTasks = JSON.parse(jsonText);
                    
                    if (Array.isArray(subTasks) && subTasks.length > 0) {
                        currentSubTasks = subTasks; // Save for Firestore
                        subTasks.forEach(task => {
                            const li = document.createElement('li');
                            li.textContent = task;
                            taskBreakdownList.appendChild(li);
                        });
                        taskBreakdownResult.classList.remove('hidden');
                    } else {
                        throw new Error("AI did not return a valid array of tasks.");
                    }
                } else {
                    throw new Error("AI returned an empty response.");
                }
                
            } catch (error) {
                console.error("Gemini Task Breakdown Error:", error);
                showAppAlert("Failed to break down task.");
                currentSubTasks = []; // Clear on error
            } finally {
                taskBreakdownLoading.classList.add('hidden');
                breakdownTaskBtn.disabled = false;
            }
        };

        
        // --- GEMINI TTS (TEXT-TO-SPEECH) FUNCTIONS ---
        
        // This Audio object will be used to play the TTS sound
        let ttsAudio = new Audio();

        /**
         * Converts a Base64 string to an ArrayBuffer.
         * @param {string} base64 - The Base64 encoded string.
         * @returns {ArrayBuffer}
         */
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };
        
        /**
         * Converts raw PCM audio data to a WAV file Blob.
         * @param {Int16Array} pcmData - The raw 16-bit PCM audio data.
         * @param {number} sampleRate - The sample rate of the audio (e.g., 24000).
         * @returns {Blob} - A Blob object representing the WAV file.
         */
        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF header
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            // "fmt " sub-chunk
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); // Sub-chunk size (16 for PCM)
            view.setUint16(20, 1, true); // Audio format (1 for PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // Bits per sample
            // "data" sub-chunk
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);

            // Write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        };


        /**
         * Calls the Gemini TTS API to speak the last AI result.
         */
        const speakResult = async () => {
            if (!lastStudyAiResult) return;
            
            // Stop any currently playing audio
            if (!ttsAudio.paused) {
                ttsAudio.pause();
                ttsAudio.currentTime = 0;
            }

            studyAiSpeakBtnText.textContent = 'Loading...';
            studyAiSpeakBtnSpinner.classList.remove('hidden');
            studyAiSpeakBtn.disabled = true;

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: `Say this clearly: ${lastStudyAiResult}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" } // A firm, clear voice
                            }
                        }
                    },
                    model: GEMINI_TTS_MODEL
                };

                // Use the *streaming* endpoint for TTS
                const apiUrl = `${GEMINI_API_URL}/${GEMINI_TTS_MODEL}:streamGenerateContent?key=${GEMINI_API_KEY}&alt=sse`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`TTS API Error: ${response.status} ${response.statusText}`);
                }
                
                // The TTS API returns a stream (SSE)
                // We need to read it and assemble the audio data
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullAudioData = "";
                let sampleRate = 24000; // Default, but should be set from response

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    // SSE data comes in "data: { ... }" chunks
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.candidates && data.candidates[0].content.parts[0].inlineData) {
                                    const part = data.candidates[0].content.parts[0];
                                    fullAudioData += part.inlineData.data;
                                    // Get sample rate from the *first* audio chunk
                                    if (part.inlineData.mimeType.includes("rate=")) {
                                        sampleRate = parseInt(part.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                                    }
                                }
                            } catch (e) {
                                // Ignore parsing errors on incomplete chunks
                            }
                        }
                    }
                }
                
                if (fullAudioData) {
                    // We have the full base64 audio data, now process it
                    const pcmData = base64ToArrayBuffer(fullAudioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    ttsAudio.src = audioUrl;
                    ttsAudio.play();
                    
                    // Reset button when audio finishes
                    ttsAudio.onended = () => {
                        studyAiSpeakBtnText.textContent = 'Read Aloud';
                        studyAiSpeakBtnSpinner.classList.add('hidden');
                        studyAiSpeakBtn.disabled = false;
                        URL.revokeObjectURL(audioUrl); // Clean up
                    };
                    
                } else {
                    throw new Error("No audio data received from TTS API.");
                }
                
            } catch (error) {
                console.error("Gemini TTS Error:", error);
                showAppAlert("Failed to generate audio.");
                studyAiSpeakBtnText.textContent = 'Read Aloud';
                studyAiSpeakBtnSpinner.classList.add('hidden');
                studyAiSpeakBtn.disabled = false;
            }
        };
        

        // --- EVENT LISTENERS ---

        /**
         * Attaches all primary event listeners for the application.
         */
        const attachEventListeners = () => {
            // Modal Triggers
            showFolderModalBtn.addEventListener('click', () => showModal('create-folder-modal'));
            showReminderModalBtn.addEventListener('click', () => {
                resetReminderModal();
                showModal('add-reminder-modal');
            });
            
            // "Quick Import" button from the main folder view
            showQuickImportModalBtn.addEventListener('click', () => showImportModal(null));
            
            // "Import File" button from *inside* a folder
            showImportModalFromFileViewBtn.addEventListener('click', () => {
                // Pass the currentFolderId so the modal knows its context
                showImportModal(currentFolderId);
            });

            // Modal Actions
            createFolderBtn.addEventListener('click', handleCreateFolder);
            setAlarmBtn.addEventListener('click', handleSetAlarm);
            saveFileBtn.addEventListener('click', handleSaveFile);

            // File View Navigation
            backToFoldersBtn.addEventListener('click', () => switchFileView('folders'));
            
            // Import File Modal Listeners
            fileImportInput.addEventListener('change', handleFileSelection);
            analyzeFileContentBtn.addEventListener('click', handleAnalyzeFileContent);

            // Study AI Listeners
            studyAiAskBtn.addEventListener('click', handleStudyQuery);
            studyAiImageInput.addEventListener('change', handleStudyAiImageSelect);
            studyAiSpeakBtn.addEventListener('click', speakResult);

            // Reminder Modal Listeners
            breakdownTaskBtn.addEventListener('click', handleTaskBreakdown);

            // Alarm Notification
            dismissAlarmBtn.addEventListener('click', () => {
                alarmNotificationModal.classList.add('hidden');
            });
        };

        // --- PWA SERVICE WORKER REGISTRATION ---
        
        /**
         * Registers the Service Worker for PWA functionality.
         */
        const registerServiceWorker = () => {
            // Register the Service Worker for PWA offline capabilities
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js') // Use root-relative path
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })

