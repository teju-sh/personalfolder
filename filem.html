<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, query, where, onSnapshot, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Gemini API Configuration ---
        const GEMINI_API_KEY = ""; // Left blank for Canvas environment
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;


        // Global Firebase variables
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAa4EpAF0CakYdQsbGxurUNXMwRH9W4IcQ",
            authDomain: "personalfolder-d9ba8.firebaseapp.com",
            projectId: "personalfolder-d9ba8",
            storageBucket: "personalfolder-d9ba8.firebasestorage.app",
            messagingSenderId: "216731617905",
            appId: "1:216731617905:web:fea13d842d3102f7c229d0",
            measurementId: "G-GLWFYE1GW0"
        };

// Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                let db;
                let auth;
                let currentUserId = null;
        
        // --- Application State Management ---
                let folders = [];
                let allFiles = []; // All files across all folders for the current user
                let activeReminders = []; // The actual list of reminders from Firestore
                const alarmedReminders = new Set(); // Tracks which reminders have already triggered the alarm in this session
                let currentView = { name: 'folders', folderId: null, folderName: null };
                let audioContext = null;
                let isAlarming = false; // Flag to prevent overlapping alarm sounds


        // --- Core Firebase Initialization and Auth ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing Firebase...');
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing or invalid.");
                document.getElementById('main-content').innerHTML = '<p class="p-4 text-red-600">Error: Firebase configuration is missing. Cannot initialize database.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await initializeAuthAndData(auth, db);

                // Setup global event listeners
                setupListeners();
                
                // Initial render of the files section (folders view)
                renderFoldersSection();
                
                // Start periodic alarm check every 60 seconds (60000 ms)
                // This will call checkReminders() regularly to see if any reminder is overdue.
                setInterval(checkReminders, 60000);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        });

        async function initializeAuthAndData(auth, db) {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Authenticated user ID:", currentUserId);
                        document.getElementById('user-id-display').textContent = `User ID: ${currentUserId.substring(0, 8)}...`;
                        startRealtimeListeners(db, currentUserId);
                        resolve();
                    } else if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        const anonUser = await signInAnonymously(auth);
                        currentUserId = anonUser.user.uid;
                        console.log("Signed in anonymously. User ID:", currentUserId);
                        document.getElementById('user-id-display').textContent = `User ID: ${currentUserId.substring(0, 8)}...`;
                        startRealtimeListeners(db, currentUserId);
                        resolve();
                    }
                });
            });
        }

        function getCollectionPath(collectionName) {
            if (!currentUserId) return null;
            // Private data storage
            return `artifacts/${appId}/users/${currentUserId}/${collectionName}`;
        }
        
        // --- Realtime Data Listeners ---
        function startRealtimeListeners(db, userId) {
            // Folders Listener
            const foldersRef = collection(db, getCollectionPath('folders'));
            const foldersQuery = query(foldersRef, where('userId', '==', userId));
            onSnapshot(foldersQuery, (snapshot) => {
                folders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Only render folders if we are on the main folder view
                if (currentView.name === 'folders') {
                    renderFolders();
                }
                console.log("Folders updated:", folders);
            }, (error) => {
                console.error("Error fetching folders:", error);
            });

            // Files Listener
            const filesRef = collection(db, getCollectionPath('files'));
            const filesQuery = query(filesRef, where('userId', '==', userId));
            onSnapshot(filesQuery, (snapshot) => {
                allFiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // If we are currently inside a folder view, re-render the files
                if (currentView.name === 'files-in-folder') {
                    renderFiles(currentView.folderId);
                }
                console.log("Files updated:", allFiles);
            }, (error) => {
                console.error("Error fetching files:", error);
            });

            // Reminders Listener
            const remindersRef = collection(db, getCollectionPath('reminders'));
            const remindersQuery = query(remindersRef, where('userId', '==', userId));
            onSnapshot(remindersQuery, (snapshot) => {
                activeReminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderReminders(activeReminders);
                checkReminders(); // Check for alarms immediately after data load/change
                console.log("Reminders updated:", activeReminders);
            }, (error) => {
                console.error("Error fetching reminders:", error);
            });
        }

        // --- View Management Functions ---

        function goBackToFolders() {
            currentView = { name: 'folders', folderId: null, folderName: null };
            renderFoldersSection();
        }

        function viewFolder(folderId, folderName) {
            currentView = { name: 'files-in-folder', folderId, folderName };
            renderFoldersSection();
        }

        // --- Rendering Functions ---
        
        // Renders the file section container based on the current view state
        function renderFoldersSection() {
            const section = document.getElementById('folders-section');
            if (!section) return;
            section.innerHTML = ''; // Clear everything

            if (currentView.name === 'folders') {
                // Render main folder list UI (the original state)
                section.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">My Folders</h2>
                        <button id="create-folder-btn" class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1a9 9 0 100 18A9 9 0 003 3z"></path></svg>
                            New Folder
                        </button>
                    </div>
                    <div id="folder-list" class="space-y-3">
                        <!-- Folders rendered here by renderFolders() -->
                        <p class="text-center text-gray-400">Loading folders...</p>
                    </div>
                `;
                // Re-attach listener for create folder button
                document.getElementById('create-folder-btn').addEventListener('click', showCreateFolderModal);
                renderFolders(); // Call the actual folder rendering function
            } else if (currentView.name === 'files-in-folder') {
                // Render files in folder UI
                section.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center flex-1 min-w-0">
                            <button id="back-to-folders-btn" class="p-2 mr-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition duration-150 flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800 truncate">${currentView.folderName}</h2>
                        </div>
                        <button id="import-file-btn" class="px-3 py-2 bg-indigo-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 flex items-center flex-shrink-0">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Import
                        </button>
                    </div>
                    <div id="file-list" class="space-y-3">
                        <!-- Files rendered here by renderFiles() -->
                    </div>
                `;
                document.getElementById('back-to-folders-btn').addEventListener('click', goBackToFolders);
                document.getElementById('import-file-btn').addEventListener('click', () => showFileImportModal(currentView.folderId, currentView.folderName));
                renderFiles(currentView.folderId);
            }
        }


        function renderFolders() {
            const container = document.getElementById('folder-list');
            if (!container) return; // Only render if the container exists (i.e., we are in the 'folders' view)
            container.innerHTML = ''; // Clear existing list
            
            if (folders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm mt-4 p-4 text-center">No folders found. Create one to get started!</p>';
                return;
            }

            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'flex items-center justify-between p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-indigo-50 transition duration-150';
                
                // Folder Info (Icon + Name)
                const info = document.createElement('div');
                info.className = 'flex items-center';
                info.innerHTML = `
                    <svg class="w-6 h-6 text-indigo-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                    <span class="text-gray-800 font-medium truncate">${folder.name}</span>
                `;

                // Actions (Delete Button)
                const actions = document.createElement('button');
                actions.className = 'text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition duration-150';
                actions.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                `;
                actions.onclick = (e) => {
                    e.stopPropagation(); // Prevent folder view change
                    showDeleteFolderModal(folder.id, folder.name);
                };

                folderItem.appendChild(info);
                folderItem.appendChild(actions);
                folderItem.onclick = () => viewFolder(folder.id, folder.name); // New: switches to file list view

                container.appendChild(folderItem);
            });
        }
        
        function renderFiles(folderId) {
            const container = document.getElementById('file-list');
            if (!container) return;
            container.innerHTML = '';

            const filesInFolder = allFiles.filter(file => file.folderId === folderId);

            if (filesInFolder.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm mt-4 p-4 text-center">No files in this folder. Tap "Import" to add one.</p>';
                return;
            }

            filesInFolder.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-xl shadow-sm border border-gray-100';

                // Icon based on type (simple simulation)
                let iconPath = '';
                let iconColor = '';
                if (file.convertedType === 'PDF') {
                    iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
                    iconColor = 'text-red-500';
                } else if (file.convertedType === 'DOCX') {
                    iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
                    iconColor = 'text-blue-500';
                } else if (file.convertedType === 'Original Image') {
                    iconPath = 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z';
                    iconColor = 'text-green-500';
                } else {
                    iconPath = 'M9 12h6m-6 4h6m-6-8h6';
                    iconColor = 'text-gray-500';
                }


                // File Info (Icon + Name + Type)
                const info = document.createElement('div');
                info.className = 'flex flex-col flex-1 truncate';
                info.innerHTML = `
                    <div class="flex items-center mb-1">
                        <svg class="w-5 h-5 ${iconColor} mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg>
                        <span class="font-medium text-gray-800 truncate">${file.name}</span>
                    </div>
                    <span class="text-xs text-gray-500 ml-7">Converted to: ${file.convertedType}</span>
                `;
                
                // Actions (Delete Button - mock action)
                const actions = document.createElement('button');
                actions.className = 'text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition duration-150 flex-shrink-0';
                actions.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                `;
                actions.onclick = () => alertMessage(`Simulating file delete for: ${file.name}`, 'bg-red-500');

                fileItem.appendChild(info);
                fileItem.appendChild(actions);
                container.appendChild(fileItem);
            });
        }
        
        function renderReminders(reminders) {
            const container = document.getElementById('reminder-list');
            container.innerHTML = '';
            
            if (reminders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm mt-4 p-4 text-center">No active reminders.</p>';
                return;
            }

            // Sort by due date (earliest first)
            reminders.sort((a, b) => (a.dueDate || 0) - (b.dueDate || 0));

            reminders.forEach(reminder => {
                const date = reminder.dueDate ? new Date(reminder.dueDate).toLocaleString() : 'No Date';
                const isOverdue = reminder.dueDate && reminder.dueDate < Date.now();
                
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 bg-white rounded-xl shadow-md mb-2 ${isOverdue ? 'border-2 border-red-400' : ''}`;
                
                const info = document.createElement('div');
                info.className = 'flex flex-col';
                info.innerHTML = `
                    <span class="font-semibold text-gray-800">${reminder.title}</span>
                    <span class="text-xs ${isOverdue ? 'text-red-600 font-bold' : 'text-indigo-500'} mt-1">
                        ${isOverdue ? 'OVERDUE: ' : ''}${date}
                    </span>
                `;

                const actions = document.createElement('button');
                actions.className = 'text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition duration-150';
                actions.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                `;
                actions.onclick = () => deleteReminder(reminder.id);

                item.appendChild(info);
                item.appendChild(actions);
                container.appendChild(item);
            });
        }


        // --- Firestore Actions ---

        async function createFolder(folderName) {
            if (!folderName || !currentUserId) return;
            try {
                const foldersRef = collection(db, getCollectionPath('folders'));
                await addDoc(foldersRef, {
                    name: folderName,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                });
                console.log("Folder created successfully:", folderName);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
        
        async function deleteFolder(folderId) {
            if (!folderId) return;
            try {
                // In a real app, you would also delete all files within this folder.
                const folderRef = doc(db, getCollectionPath('folders'), folderId);
                await deleteDoc(folderRef);
                console.log("Folder deleted successfully:", folderId);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        async function addFileMetadata(folderId, folderName, fileName, fileType, convertedType) {
            if (!currentUserId) return;
            try {
                const filesRef = collection(db, getCollectionPath('files'));
                await addDoc(filesRef, {
                    name: fileName,
                    originalType: fileType,
                    convertedType: convertedType,
                    folderId: folderId,
                    folderName: folderName,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                });
                console.log(`File metadata stored: ${fileName} converted to ${convertedType} in ${folderName}`);
                // After saving metadata, if we are in this folder view, refresh the file list
                if (currentView.name === 'files-in-folder' && currentView.folderId === folderId) {
                    renderFiles(folderId);
                }
            } catch (e) {
                console.error("Error storing file metadata: ", e);
            }
        }

        async function addReminder(title, dateString) {
            if (!title || !currentUserId) return;
            
            let timestamp = null;
            if (dateString) {
                // Note: Firestore stores dates as Timestamps. We'll store milliseconds for simple sorting/display.
                timestamp = new Date(dateString).getTime(); 
            }

            try {
                const remindersRef = collection(db, getCollectionPath('reminders'));
                await addDoc(remindersRef, {
                    title: title,
                    dueDate: timestamp,
                    isActive: true,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                });
                console.log("Reminder created successfully:", title);
            } catch (e) {
                console.error("Error adding reminder: ", e);
            }
        }

        async function deleteReminder(reminderId) {
            if (!reminderId) return;
            try {
                const reminderRef = doc(db, getCollectionPath('reminders'), reminderId);
                await deleteDoc(reminderRef);
                console.log("Reminder deleted successfully:", reminderId);
            } catch (e) {
                console.error("Error deleting reminder: ", e);
            }
        }
        
        // --- Audio Alarm Logic ---

        function playBeepAlarm() {
            if (isAlarming) return; // Prevent overlapping alarms
            isAlarming = true;
            
            if (!audioContext) {
                // Initialize AudioContext on first call
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            let beepCount = 0;
            const maxBeeps = 2;
            const beepDuration = 0.2; // seconds
            const beepFrequency = 700; // Hz (a clear tone)

            function scheduleBeep(time) {
                if (beepCount >= maxBeeps) {
                    isAlarming = false;
                    return;
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Set oscillator properties
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(beepFrequency, time);

                // Start immediately
                oscillator.start(time);
                
                // Gradually fade out
                gainNode.gain.setValueAtTime(1, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + beepDuration);
                
                // Stop after duration
                oscillator.stop(time + beepDuration);

                beepCount++;
                
                // Schedule the next beep after a small pause
                if (beepCount < maxBeeps) {
                    const nextTime = time + beepDuration + 0.1; // 0.1s pause
                    // Use setTimeout to schedule the next beep since we can't accurately schedule multiple Web Audio events across a long time span
                    setTimeout(() => scheduleBeep(audioContext.currentTime), (beepDuration + 0.1) * 1000);
                }
            }

            scheduleBeep(audioContext.currentTime);
        }

        // --- Reminder Check Logic ---

        function checkReminders() {
            const now = Date.now();
            
            activeReminders.forEach(reminder => {
                // Check if the reminder has a due date, is past due, and hasn't been alarmed yet in this session
                if (reminder.dueDate && reminder.dueDate <= now && !alarmedReminders.has(reminder.id)) {
                    
                    // Show message
                    alertMessage(`🔔 ALARM: ${reminder.title} is due! Check your reminders tab.`, "bg-red-600");

                    // Play sound (two beeps)
                    playBeepAlarm();
                    
                    // Mark as alarmed to prevent repeating alarm in this session
                    alarmedReminders.add(reminder.id);
                }
            });
        }


        // --- LLM AI Logic ---

        async function fetchGeminiResponse(userQuery, systemInstruction = null, useGrounding = true) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: useGrounding ? [{ "google_search": {} }] : undefined,
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
            };

            const maxRetries = 3;
            let delay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue; 
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };

                    } else {
                        return { text: "I'm sorry, I couldn't generate a helpful response for that query.", sources: [] };
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === maxRetries - 1) {
                         return { text: "An error occurred while communicating with the AI. Please try again later.", sources: [] };
                    }
                }
            }
        }

        async function handleStudyQuery() {
            const inputElement = document.getElementById('study-query-input');
            const resultsDiv = document.getElementById('study-results');
            const query = inputElement.value.trim();

            if (!query) {
                alertMessage("Please enter a question or topic to study.", "bg-red-500");
                return;
            }

            // Show loading state
            const loadingHtml = `
                <div class="flex items-center justify-center p-4 bg-gray-100 rounded-lg text-indigo-600">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Thinking... (Using Google Search to ground the response)
                </div>
            `;
            resultsDiv.innerHTML = loadingHtml;
            inputElement.disabled = true;
            document.getElementById('ai-generate-btn').disabled = true;

            const systemInstruction = "You are a friendly, encouraging, and knowledgeable student tutor. Provide a concise, easy-to-understand answer suitable for a student in high school or college. For definitions or concepts, structure the answer clearly. If the query asks for a study strategy or tip, provide three actionable steps.";

            const { text, sources } = await fetchGeminiResponse(query, systemInstruction);

            // Hide loading state
            inputElement.disabled = false;
            document.getElementById('ai-generate-btn').disabled = false;
            
            let sourceHtml = '';
            if (sources.length > 0) {
                sourceHtml = `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Sources:</p>
                        <ul class="space-y-1">
                            ${sources.map((src, index) => `
                                <li class="text-xs text-gray-600 truncate">
                                    <a href="${src.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700 transition">${src.title || 'Source Link'}</a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            resultsDiv.innerHTML = `
                <div class="p-4 bg-white rounded-xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Result:</h4>
                    <div class="prose max-w-none text-gray-700">
                        <p>${text.replace(/\n/g, '<br>')}</p>
                    </div>
                    ${sourceHtml}
                </div>
            `;
        }

        // --- UI Modal Logic ---

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        // FIX: Expose modal functions to the global window object so that inline HTML onclick handlers can access them.
        window.showModal = showModal;
        window.hideModal = hideModal;


        // Folder Creation/Deletion Modals
        function showCreateFolderModal() {
            document.getElementById('new-folder-input').value = '';
            showModal('create-folder-modal');
        }

        function handleCreateFolder() {
            const name = document.getElementById('new-folder-input').value.trim();
            if (name) {
                createFolder(name);
                hideModal('create-folder-modal');
            }
        }
        
        function showDeleteFolderModal(folderId, folderName) {
            document.getElementById('delete-folder-name').textContent = folderName;
            document.getElementById('confirm-delete-button').onclick = () => {
                deleteFolder(folderId);
                hideModal('delete-folder-modal');
            };
            showModal('delete-folder-modal');
        }
        
        // File Import Modal (The core feature)
        let targetFolderId = null;
        let targetFolderName = null;
        
        function showFileImportModal(folderId, folderName) {
            targetFolderId = folderId;
            targetFolderName = folderName;
            document.getElementById('file-import-folder-display').textContent = targetFolderName;
            document.getElementById('file-upload-input').value = '';
            document.getElementById('file-name-display').textContent = 'Select a file...';
            document.getElementById('file-conversion-form').reset();
            showModal('file-import-modal');
        }
        
        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('file-name-display').textContent = file.name;
                // Pre-fill suggested name
                const suggestedName = file.name.split('.').slice(0, -1).join('.');
                document.getElementById('converted-file-name-input').value = suggestedName;
            } else {
                document.getElementById('file-name-display').textContent = 'Select a file...';
            }
        }

        function handleFileImport() {
            const fileInput = document.getElementById('file-upload-input');
            const file = fileInput.files[0];
            const fileNameInput = document.getElementById('converted-file-name-input').value.trim();
            const conversionType = document.querySelector('input[name="conversion-type"]:checked')?.value;
            
            if (!file || !fileNameInput || !conversionType) {
                console.error("Missing file, name, or conversion type.");
                return; 
            }

            // Simulate file storage by storing metadata
            addFileMetadata(
                targetFolderId, 
                targetFolderName, 
                fileNameInput, 
                file.type, 
                conversionType
            );
            
            hideModal('file-import-modal');
            alertMessage(`Successfully 'converted' ${file.name} to ${conversionType} in ${targetFolderName}. (Metadata stored)`);
        }

        // Reminder Modal
        function showReminderModal() {
            document.getElementById('reminder-title-input').value = '';
            document.getElementById('reminder-date-input').value = '';
            showModal('add-reminder-modal');
        }

        function handleAddReminder() {
            const title = document.getElementById('reminder-title-input').value.trim();
            const date = document.getElementById('reminder-date-input').value;

            if (title) {
                addReminder(title, date);
                hideModal('add-reminder-modal');
            } else {
                alertMessage("Reminder title cannot be empty.", "bg-red-500");
            }
        }

        // Global Alert Message (instead of window.alert)
        function alertMessage(message, color = "bg-indigo-500") {
            const alertBox = document.getElementById('global-alert');
            alertBox.textContent = message;
            alertBox.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-lg shadow-lg z-50 transition-opacity duration-300 ${color}`;
            alertBox.classList.remove('opacity-0', 'hidden');
            alertBox.classList.add('opacity-100');

            setTimeout(() => {
                alertBox.classList.remove('opacity-100');
                alertBox.classList.add('opacity-0');
                setTimeout(() => alertBox.classList.add('hidden'), 300);
            }, 5000); // Increased duration to 5s for alarms
        }

        // --- Setup Event Listeners ---
        function setupListeners() {
            // Note: The create-folder-btn listener is now dynamically attached/detached in renderFoldersSection
            document.getElementById('confirm-create-folder').addEventListener('click', handleCreateFolder);
            document.getElementById('add-reminder-btn').addEventListener('click', showReminderModal);
            document.getElementById('confirm-add-reminder').addEventListener('click', handleAddReminder);
            document.getElementById('file-upload-input').addEventListener('change', handleFileSelection);
            document.getElementById('confirm-file-import').addEventListener('click', handleFileImport);
            
            // LLM listener
            document.getElementById('ai-generate-btn').addEventListener('click', handleStudyQuery);
            document.getElementById('study-query-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleStudyQuery();
                }
            });

            // Tab switching logic
            const tabs = document.querySelectorAll('.tab-btn');
            const sections = document.querySelectorAll('.content-section');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Reset to folders view if clicking the Files tab
                    if (tab.getAttribute('data-target') === 'folders-section') {
                        goBackToFolders();
                    }
                    
                    tabs.forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600', 'font-semibold'));
                    tab.classList.add('border-indigo-500', 'text-indigo-600', 'font-semibold');

                    const target = tab.getAttribute('data-target');
                    sections.forEach(s => s.classList.add('hidden'));
                    document.getElementById(target).classList.remove('hidden');
                });
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom radio button style for file conversion */
        input[type="radio"]:checked + label {
            background-color: #6366f1; /* Indigo-500 */
            color: white;
            border-color: #6366f1;
        }
        .prose p {
            margin-bottom: 1em;
        }
        .prose ul, .prose ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .prose ul li {
            list-style-type: disc;
        }
        .prose ol li {
            list-style-type: decimal;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Global Alert Message -->
    <div id="global-alert" class="hidden opacity-0"></div>

    <!-- Main Mobile Container -->
    <div id="main-content" class="max-w-md mx-auto bg-white shadow-2xl min-h-screen">
        
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 flex justify-between items-center rounded-b-xl shadow-lg">
            <div>
                <h1 class="text-2xl font-bold">Student Organizer</h1>
                <p id="user-id-display" class="text-xs opacity-75">User ID: N/A</p>
            </div>
            <!-- Main Add Button -->
            <button id="add-reminder-btn" class="bg-white text-indigo-600 p-2 rounded-full shadow-lg hover:bg-indigo-100 transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 sticky top-0 bg-white z-10">
            <button class="flex-1 p-3 text-center border-b-2 tab-btn border-indigo-500 text-indigo-600 font-semibold" data-target="folders-section">
                Files
            </button>
            <button class="flex-1 p-3 text-center border-b-2 tab-btn border-transparent text-gray-500 hover:text-indigo-600" data-target="reminders-section">
                Reminders
            </button>
            <button class="flex-1 p-3 text-center border-b-2 tab-btn border-transparent text-gray-500 hover:text-indigo-600" data-target="study-ai-section">
                ✨ Study AI
            </button>
        </div>

        <!-- --- Folders & File Content Section (Dynamic Content) --- -->
        <div id="folders-section" class="p-4 content-section">
            <!-- Content dynamically rendered by renderFoldersSection() -->
            <p class="text-center text-gray-400">Initializing views...</p>
        </div>

        <!-- --- Reminders Content Section --- -->
        <div id="reminders-section" class="p-4 content-section hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Upcoming Reminders</h2>
            <div id="reminder-list" class="space-y-3">
                <!-- Reminders rendered here by JS -->
                <p class="text-center text-gray-400">Loading reminders...</p>
            </div>
            
        </div>

        <!-- --- Study AI Content Section (New) --- -->
        <div id="study-ai-section" class="p-4 content-section hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                ✨ Study AI Assistant
            </h2>
            <p class="text-sm text-gray-500 mb-4">Ask any academic question or request study tips (e.g., "Explain photosynthesis" or "Best way to study for finals").</p>

            <div class="flex space-x-2 mb-6">
                <input type="text" id="study-query-input" placeholder="Enter your question or topic..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button id="ai-generate-btn" class="px-4 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition font-semibold">
                    Ask
                </button>
            </div>

            <!-- AI Results Area -->
            <div id="study-results" class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200 text-gray-700">
                    Your answers, grounded by Google Search, will appear here.
                </div>
            </div>
        </div>
        <!-- --------------------------------------- -->

    </div>

    <!-- --- Modals --- -->

    <!-- 1. Create Folder Modal -->
    <div id="create-folder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="hideModal('create-folder-modal')">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Create New Folder</h3>
            <input type="text" id="new-folder-input" placeholder="Enter folder name (e.g., 'Physics Notes')" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('create-folder-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                <button id="confirm-create-folder" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition">Create</button>
            </div>
        </div>
    </div>

    <!-- 2. Delete Folder Confirmation Modal -->
    <div id="delete-folder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="hideModal('delete-folder-modal')">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-2 text-red-600">Confirm Deletion</h3>
            <p class="text-gray-700 mb-4">Are you sure you want to delete the folder: <span id="delete-folder-name" class="font-semibold text-red-700"></span>?</p>
            <p class="text-sm text-gray-500 mb-6">All files in this folder will also be removed from the list (mock deletion).</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('delete-folder-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                <button id="confirm-delete-button" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- 3. File Import/Conversion Modal (The complex step) -->
    <div id="file-import-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="hideModal('file-import-modal')">
        <div class="bg-white p-6 rounded-2xl w-full max-w-lg shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Import & Convert File</h3>
            <p class="text-sm text-gray-500 mb-4">Destination Folder: <span id="file-import-folder-display" class="font-semibold text-indigo-700"></span></p>

            <form id="file-conversion-form">
                <!-- File Selection -->
                <label class="block text-sm font-medium text-gray-700 mb-2">1. Select Your File (e.g., Photo)</label>
                <input type="file" id="file-upload-input" accept="image/*" class="hidden">
                <label for="file-upload-input" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg mb-4 text-center cursor-pointer hover:bg-gray-50 transition block">
                    <span id="file-name-display" class="text-indigo-600 font-medium">Select a file...</span>
                </label>

                <!-- File Name Input -->
                <label for="converted-file-name-input" class="block text-sm font-medium text-gray-700 mb-2">2. Name Your New File</label>
                <input type="text" id="converted-file-name-input" placeholder="Enter file name without extension" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500">
                
                <!-- Conversion Type Selection -->
                <label class="block text-sm font-medium text-gray-700 mb-3">3. Choose Output Type (Conversion)</label>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <!-- Option 1: PDF -->
                    <div>
                        <input type="radio" id="type-pdf" name="conversion-type" value="PDF" class="hidden">
                        <label for="type-pdf" class="flex items-center justify-center p-3 border-2 border-gray-300 rounded-xl cursor-pointer transition text-gray-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            PDF
                        </label>
                    </div>
                    <!-- Option 2: DOCX -->
                    <div>
                        <input type="radio" id="type-docx" name="conversion-type" value="DOCX" class="hidden">
                        <label for="type-docx" class="flex items-center justify-center p-3 border-2 border-gray-300 rounded-xl cursor-pointer transition text-gray-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            DOCX
                        </label>
                    </div>
                    <!-- Option 3: Original Image -->
                    <div>
                        <input type="radio" id="type-img" name="conversion-type" value="Original Image" class="hidden" checked>
                        <label for="type-img" class="flex items-center justify-center p-3 border-2 border-gray-300 rounded-xl cursor-pointer transition text-gray-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Image
                        </label>
                    </div>
                    <!-- Option 4: Plain Text (OCR Simulation) -->
                    <div>
                        <input type="radio" id="type-txt" name="conversion-type" value="TXT (OCR)" class="hidden">
                        <label for="type-txt" class="flex items-center justify-center p-3 border-2 border-gray-300 rounded-xl cursor-pointer transition text-gray-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-6-8h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m-4 7h17"></path></svg>
                            Text (OCR)
                        </label>
                    </div>
                </div>
            </form>

            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('file-import-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                <button id="confirm-file-import" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition">Save & Store</button>
            </div>
        </div>
    </div>

    <!-- 4. Add Reminder Modal -->
    <div id="add-reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="hideModal('add-reminder-modal')">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Set a New Reminder</h3>
            
            <label for="reminder-title-input" class="block text-sm font-medium text-gray-700 mb-2">Reminder Title (e.g., 'Submit History Paper')</label>
            <input type="text" id="reminder-title-input" placeholder="Title" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500">
            
            <label for="reminder-date-input" class="block text-sm font-medium text-gray-700 mb-2">Due Date / Time (Optional)</label>
            <input type="datetime-local" id="reminder-date-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500">
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideModal('add-reminder-modal')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                <button id="confirm-add-reminder" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition">Set Alarm</button>
            </div>
        </div>
    </div>

</body>
</html>


